<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Re√ßete & Tarif Defteri</title>
<link rel="apple-touch-icon" sizes="180x180" href="recete-tarif-defteri-icon.png">
<meta name="theme-color" content="#121212">
<style>
  :root{--bg:#121212;--card:#1e1e1e;--text:#fff;--muted:#bdbdbd;--accent:#4caf50;--line:#2a2a2a}
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Arial;background:var(--bg);color:var(--text)}
  .app{max-width:1100px;margin:0 auto;padding:16px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap}
  .title{font-weight:700;font-size:20px}
  .search{flex:1;min-width:260px;max-width:520px;display:flex;gap:8px;align-items:center;background:var(--card);border:1px solid var(--line);border-radius:12px;padding:8px 10px}
  .search input{flex:1;border:0;outline:0;background:transparent;color:var(--text);font-size:14px}
  .btn{border:0;border-radius:10px;background:var(--accent);color:#fff;font-weight:700;padding:10px 12px;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
  .btn.ghost{background:#2a2a2a}.btn.warn{background:#d32f2f}.btn.small{padding:6px 9px;font-weight:600}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .grid{display:grid;gap:14px;grid-template-columns:1fr}
  @media(min-width:960px){.grid{grid-template-columns:340px 1fr}}
  .panel{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .tagbar{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 10px}
  .chip{padding:6px 10px;border-radius:999px;background:#2a2a2a;border:1px solid var(--line);font-size:12px;cursor:pointer}
  .chip.active{background:var(--accent)}
  .list{display:flex;flex-direction:column;gap:10px;max-height:72vh;overflow:auto}
  .card{display:flex;gap:10px;background:#171717;border:1px solid var(--line);border-radius:12px;padding:10px;cursor:pointer}
  .thumb{width:64px;height:64px;border-radius:10px;object-fit:cover;background:#0f0f0f;border:1px solid #222}
  .meta{display:flex;flex-direction:column;gap:4px}.meta .name{font-weight:700}.meta .sub{color:var(--muted);font-size:12px}
  .detail{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px;min-height:260px}
  .hero{display:flex;gap:14px;flex-wrap:wrap;align-items:center}
  .hero img{width:120px;height:120px;border-radius:14px;object-fit:cover;background:#101010;border:1px solid #222}
  .h1{font-size:20px;font-weight:800;margin:0 0 6px}
  .muted{color:var(--muted);font-size:13px}
  .kvs{display:flex;gap:12px;flex-wrap:wrap;margin-top:6px}
  .kv{background:#171717;border:1px solid var(--line);border-radius:10px;padding:6px 10px;font-size:12px}
  .section{margin-top:14px}.section h3{margin:0 0 8px;font-size:14px;font-weight:800}
  .inglist,.steplist{display:flex;flex-direction:column;gap:8px}
  .ing{display:flex;align-items:flex-start;gap:10px;background:#161616;border:1px solid #262626;border-radius:10px;padding:8px}
  .step{display:flex;gap:8px;background:#161616;border:1px solid #262626;border-radius:10px;padding:10px}
  .num{min-width:26px;height:26px;border-radius:7px;background:#2a2a2a;display:flex;align-items:center;justify-content:center;font-weight:800}
  .empty{display:grid;place-items:center;min-height:240px;color:var(--muted);text-align:center}
  .modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.5);z-index:9999}
  .modal.open{display:flex}
  .sheet{background:var(--card);border-top-left-radius:16px;border-top-right-radius:16px;border:1px solid var(--line);width:100%;max-width:720px;padding:14px}
  @media(min-width:740px){.sheet{border-radius:16px;margin:40px;max-height:80vh;overflow:auto}.modal{align-items:center}}
  .row{display:flex;gap:10px;flex-wrap:wrap}.field{flex:1;min-width:200px;display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;color:var(--muted)}
  input[type="text"],input[type="number"],input[type="file"],textarea{background:#141414;border:1px solid var(--line);color:var(--text);border-radius:10px;padding:10px;font-size:14px;outline:none}
  textarea{min-height:90px;resize:vertical}
  .preview{width:100%;max-height:200px;object-fit:cover;border-radius:12px;border:1px solid #222;background:#0f0f0f}
  .diag{position:fixed;right:10px;bottom:10px;background:#2a2a2a;border:1px solid #333;color:#ddd;border-radius:20px;padding:6px 10px;font-size:12px;z-index:10000}
  .diag.good{background:#1b5e20}.diag.bad{background:#8e0000}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="title">üç≥ Re√ßete & Tarif Defteri</div>
    <div class="search">
      <input id="q" placeholder="Ara: tarif adƒ±, etiket, malzeme‚Ä¶">
      <button class="btn small ghost" id="clearSearch" type="button"
        onclick="document.getElementById('q').value='';(window.__renderList||function(){})();">
        Temizle
      </button>
    </div>
    <div class="toolbar">
      <button class="btn small" id="addBtn" type="button"
        onclick="(function(){const m=document.getElementById('modal');m.classList.add('open');m.setAttribute('aria-hidden','false');setTimeout(()=>document.getElementById('fName')?.focus(),50);} )()">
        + Yeni Tarif
      </button>
      <button class="btn small ghost" id="exportBtn" type="button"
        onclick="(function(){try{const b=new Blob([localStorage.getItem('tarifdefteri.v1')||'{}'],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='tarifler.json';document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(a.href),1500);}catch(e){alert('Dƒ±≈üa aktarma hatasƒ±')}})()">
        Dƒ±≈üa Aktar
      </button>
      <label class="btn small ghost" style="cursor:pointer" for="importFile">ƒ∞√ße Aktar</label>
      <input type="file" id="importFile" accept="application/json" hidden
        onchange="(function(el){const f=el.files&&el.files[0];if(!f)return;const r=new FileReader();r.onload=function(){try{const o=JSON.parse(r.result);if(o&&Array.isArray(o.recipes)){localStorage.setItem('tarifdefteri.v1',JSON.stringify(o));location.reload();}else alert('Ge√ßersiz dosya');}catch(e){alert('JSON okunamadƒ±')}};r.readAsText(f)})(this)">
      <button class="btn small ghost" id="printBtn" type="button" onclick="window.print()">Yazdƒ±r/PDF</button>
    </div>
  </header>

  <div class="grid">
    <div class="panel">
      <div class="muted">Etikete g√∂re filtrele:</div>
      <div id="tagBar" class="tagbar"></div>
      <div id="list" class="list"></div>
    </div>

    <div class="detail" id="detail">
      <div class="empty">Soldan bir tarif se√ßin ya da ‚Äú+ Yeni Tarif‚Äù ile ekleyin.</div>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal" id="modal" aria-hidden="true" onclick="if(event.target===this){this.classList.remove('open');this.setAttribute('aria-hidden','true');}">
  <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div class="h1" id="modalTitle">Yeni Tarif</div>
      <div class="toolbar">
        <button class="btn ghost small" id="closeModal" type="button"
          onclick="const m=document.getElementById('modal');m.classList.remove('open');m.setAttribute('aria-hidden','true');">
          Kapat
        </button>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="fName">Tarif Adƒ±</label>
        <input id="fName" type="text" placeholder="√ñrn: Fƒ±rƒ±nda Tavuk & Sebze">
      </div>
      <div class="field">
        <label for="fTags">Etiketler (virg√ºlle ayƒ±r)</label>
        <input id="fTags" type="text" placeholder="pratik, fƒ±rƒ±n, diyet">
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="fServes">Porsiyon</label>
        <input id="fServes" type="number" min="1" step="1" placeholder="4">
      </div>
      <div class="field">
        <label for="fTime">S√ºre (dk)</label>
        <input id="fTime" type="number" min="0" step="5" placeholder="35">
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="fIngs">Malzemeler (her satƒ±r bir madde)</label>
        <textarea id="fIngs" placeholder="2 adet tavuk g√∂ƒüs√º
1 kabak
1 kƒ±rmƒ±zƒ± biber
1 soƒüan
2 yemek ka≈üƒ±ƒüƒ± zeytinyaƒüƒ±
tuz, karabiber"></textarea>
      </div>
      <div class="field">
        <label for="fSteps">Adƒ±mlar (her satƒ±r bir adƒ±m)</label>
        <textarea id="fSteps" placeholder="Fƒ±rƒ±nƒ± 190¬∞C ƒ±sƒ±t.
Sebzeleri doƒüra.
Tavuklarƒ± doƒürayƒ±p baharatla karƒ±≈ütƒ±r.
Yaƒülanmƒ±≈ü tepsiye yay.
35 dk pi≈üir."></textarea>
      </div>
    </div>

    <div class="row">
      <div class="field">
        <label for="fPhoto">Kapak G√∂rseli (isteƒüe baƒülƒ±)</label>
        <input id="fPhoto" type="file" accept="image/*"
          onchange="(function(el){const f=el.files&&el.files[0];if(!f)return;const r=new FileReader();r.onload=function(){var p=document.getElementById('fPreview');p.src=r.result;p.style.display='block';};r.readAsDataURL(f);} )(this)">
        <img id="fPreview" class="preview" style="display:none" alt="">
      </div>
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button class="btn warn" id="deleteBtn" type="button" style="display:none"
        onclick="(function(){const m=document.getElementById('modal');const id=m.dataset.editId;if(!id)return;const db=JSON.parse(localStorage.getItem('tarifdefteri.v1')||'{}');db.recipes=(db.recipes||[]).filter(x=>x.id!==id);localStorage.setItem('tarifdefteri.v1',JSON.stringify(db));m.classList.remove('open');m.setAttribute('aria-hidden','true');location.reload();})()">
        Sil
      </button>
      <button class="btn" id="saveBtn" type="button" onclick="window.__fallbackSave && __fallbackSave()">Kaydet</button>
    </div>
  </div>
</div>

<div id="diag" class="diag">Y√ºkleniyor‚Ä¶</div>

<script>
(function(){
  const diag = document.getElementById('diag');
  const $ = (s,root=document)=>root.querySelector(s);
  const storeKey='tarifdefteri.v1';
  let data, activeId;
  const listEl=$('#list'), detailEl=$('#detail'), tagBar=$('#tagBar'), qInput=$('#q');
  const modal=$('#modal');
  const fName=$('#fName'), fTags=$('#fTags'), fServes=$('#fServes'), fTime=$('#fTime'),
        fIngs=$('#fIngs'), fSteps=$('#fSteps'), fPreview=$('#fPreview');

  const ok = !!listEl && !!detailEl && !!modal && !!fName;
  diag.textContent = ok ? 'Butonlar baƒülandƒ± ‚úì' : 'Baƒülama hatasƒ± ‚õî';
  diag.classList.add(ok ? 'good' : 'bad');

  function uid(){ return Math.random().toString(36).slice(2,9) }
  function load(){
    try{ const raw=localStorage.getItem(storeKey); return raw? JSON.parse(raw): sample(); }
    catch(e){ return sample(); }
  }
  function save(){ localStorage.setItem(storeKey, JSON.stringify(data)) }
  function sample(){ return { recipes:[{
    id: uid(), name:"Fƒ±rƒ±nda Sebzeli Tavuk", tags:["pratik","fƒ±rƒ±n","ak≈üam"],
    serves:4, time:35, photo:"", ingredients:[
      {t:"2 adet tavuk g√∂ƒüs√º",done:false},{t:"1 kabak",done:false},{t:"1 kƒ±rmƒ±zƒ± biber",done:false},
      {t:"1 soƒüan",done:false},{t:"2 YK zeytinyaƒüƒ±",done:false},{t:"Tuz & karabiber",done:false}
    ], steps:["Fƒ±rƒ±nƒ± 190¬∞C ƒ±sƒ±t.","Sebzeleri ve tavuƒüu doƒüra.","Baharat ve yaƒüla karƒ±≈ütƒ±r.","Tepsiye yay, 35 dk pi≈üir."],
    created:Date.now(), updated:Date.now()
  }]}; }
  function esc(s){ return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function allTags(){ const s=new Set(); data.recipes.forEach(r=>(r.tags||[]).forEach(t=>s.add(t))); return [...s].sort(); }
  let tagFilter=null;

  function renderTagBar(){
    tagBar.innerHTML='';
    const any=document.createElement('div'); any.className='chip'+(tagFilter===null?' active':''); any.textContent='T√ºm√º';
    any.onclick=()=>{ tagFilter=null; renderAll(); };
    tagBar.appendChild(any);
    allTags().forEach(t=>{
      const el=document.createElement('div'); el.className='chip'+(tagFilter===t?' active':''); el.textContent=t;
      el.onclick=()=>{ tagFilter=(tagFilter===t?null:t); renderAll(); };
      tagBar.appendChild(el);
    });
  }

  function matches(r,q){
    if(!q) return true; q=q.toLowerCase();
    return (r.name||'').toLowerCase().includes(q)
      || (r.tags||[]).join(' ').toLowerCase().includes(q)
      || (r.ingredients||[]).some(i=>(i.t||'').toLowerCase().includes(q));
  }

  function renderList(){
    const q=qInput.value.trim();
    const items=data.recipes
      .filter(r=>tagFilter?(r.tags||[]).includes(tagFilter):true)
      .filter(r=>matches(r,q))
      .sort((a,b)=>b.updated-a.updated);

    listEl.innerHTML='';
    if(items.length===0){ listEl.innerHTML='<div class="muted">Sonu√ß yok.</div>'; return; }
    items.forEach(r=>{
      const card=document.createElement('div'); card.className='card';
      const img=document.createElement('img'); img.className='thumb';
      img.src=r.photo||'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="%23101010"/><text x="50%" y="55%" font-family="Arial" font-size="10" fill="%23333" text-anchor="middle">FOTO</text></svg>';
      const meta=document.createElement('div'); meta.className='meta';
      meta.innerHTML=`<div class="name">${esc(r.name)}</div><div class="sub">${(r.tags||[]).map(t=>'#'+t).join(' ')} ‚Ä¢ ${r.time||'-'} dk ‚Ä¢ ${r.serves||'-'} porsiyon</div>`;
      card.appendChild(img); card.appendChild(meta);
      card.onclick=()=>{ activeId=r.id; renderDetail(); };
      listEl.appendChild(card);
    });
  }

  function renderDetail(){
    const r=data.recipes.find(x=>x.id===activeId);
    if(!r){ detailEl.innerHTML='<div class="empty">Soldan bir tarif se√ßin ya da ‚Äú+ Yeni Tarif‚Äù.</div>'; return; }
    const ingHTML=(r.ingredients||[]).map((ing,i)=>`<label class="ing"><input type="checkbox" ${ing.done?'checked':''} data-ing="${i}"><div>${esc(ing.t)}</div></label>`).join('');
    const stepHTML=(r.steps||[]).map((s,i)=>`<div class="step"><div class="num">${i+1}</div><div>${esc(s)}</div></div>`).join('');
    detailEl.innerHTML=`
      <div class="hero">
        <img src="${r.photo||'data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' width=\\'120\\' height=\\'120\\'><rect width=\\'100%\\' height=\\'100%\\' fill=\\'%23101010\\'/><text x=\\'50%\\' y=\\'55%\\' font-family=\\'Arial\\' font-size=\\'12\\' fill=\\'%23333\\' text-anchor=\\'middle\\'>FOTO</text></svg>'}">
        <div class="info">
          <h2 class="h1">${esc(r.name)}</h2>
          <div class="muted">Etiketler: ${(r.tags||[]).map(t=>'#'+t).join(' ')||'‚Äî'}</div>
          <div class="kvs"><div class="kv">‚è± ${r.time||'-'} dk</div><div class="kv">üë• ${r.serves||'-'} porsiyon</div><div class="kv">üóì ${new Date(r.updated).toLocaleDateString()}</div></div>
          <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn small" id="editBtn" type="button"
              onclick="(function(){const m=document.getElementById('modal');document.getElementById('modalTitle').textContent='Tarifi D√ºzenle';document.getElementById('deleteBtn').style.display='inline-flex';m.dataset.editId='${r.id}';document.getElementById('fName').value=${JSON.stringify(r.name)};document.getElementById('fTags').value=${JSON.stringify((r.tags||[]).join(', '))};document.getElementById('fServes').value='${r.serves||''}';document.getElementById('fTime').value='${r.time||''}';document.getElementById('fIngs').value=${JSON.stringify((r.ingredients||[]).map(i=>i.t).join('\\n'))};document.getElementById('fSteps').value=${JSON.stringify((r.steps||[]).join('\\n'))};(function(){var p=document.getElementById('fPreview');if(${JSON.stringify(r.photo||'')}!=''){p.src=${JSON.stringify(r.photo||'')};p.style.display='block';}else{p.src='';p.style.display='none';}})();m.classList.add('open');m.setAttribute('aria-hidden','false');setTimeout(()=>document.getElementById('fName').focus(),50);} )()">
              D√ºzenle
            </button>
            <button class="btn small ghost" id="dupBtn" type="button"
              onclick="(function(){const db=JSON.parse(localStorage.getItem('tarifdefteri.v1')||'{}');const u=Math.random().toString(36).slice(2,9);const copy=${JSON.stringify(r)};copy.id=u;copy.name=copy.name+' (Kopya)';copy.created=Date.now();copy.updated=Date.now();db.recipes=(db.recipes||[]);db.recipes.unshift(copy);localStorage.setItem('tarifdefteri.v1',JSON.stringify(db));location.reload();})()">
              Kopya Olu≈ütur
            </button>
            <button class="btn small warn" id="delBtn" type="button"
              onclick="(function(){if(!confirm('Bu tarifi silmek istiyor musunuz?'))return;const db=JSON.parse(localStorage.getItem('tarifdefteri.v1')||'{}');db.recipes=(db.recipes||[]).filter(x=>x.id!=='${r.id}');localStorage.setItem('tarifdefteri.v1',JSON.stringify(db));location.reload();})()">
              Sil
            </button>
          </div>
        </div>
      </div>
      <div class="section"><h3>Malzemeler</h3><div class="inglist" id="ingList">${ingHTML}</div></div>
      <div class="section"><h3>Adƒ±mlar</h3><div class="steplist">${stepHTML}</div></div>`;

    $('#ingList',detailEl)?.addEventListener('change',(e)=>{
      const idx=Number(e.target.dataset.ing);
      if(!isNaN(idx) && r.ingredients[idx]){ r.ingredients[idx].done=e.target.checked; r.updated=Date.now(); save(); }
    });
  }

  // Fallback ile payla≈üƒ±lan kayƒ±t fonksiyonu
  window.__fallbackSave = function(){
    const $id = (x)=>document.getElementById(x);
    const name = ($id('fName').value||'').trim();
    if(!name){ alert('Tarif adƒ± gerekli.'); $id('fName').focus(); return; }
    const tags = ($id('fTags').value||'').split(',').map(s=>s.trim()).filter(Boolean).map(s=>s.toLowerCase());
    const serves = parseInt($id('fServes').value)||null;
    const time   = parseInt($id('fTime').value)||null;
    const ingredients = ($id('fIngs').value||'').split('\n').map(s=>s.trim()).filter(Boolean).map(t=>({t,done:false}));
    const steps = ($id('fSteps').value||'').split('\n').map(s=>s.trim()).filter(Boolean);
    const photoEl = $id('fPreview');
    const photo = (photoEl && photoEl.style.display!=='none' && photoEl.src) ? photoEl.src : '';
    const now = Date.now();
    const raw = localStorage.getItem(storeKey);
    let db = {recipes:[]};
    try{ if(raw) db = JSON.parse(raw) }catch(e){ db={recipes:[]} }

    const editId = document.getElementById('modal').dataset.editId || '';
    if(editId){
      // d√ºzenleme
      db.recipes = (db.recipes||[]).map(r=>{
        if(r.id!==editId) return r;
        // malzemelerde done durumunu koru
        const prevIngs = (r.ingredients||[]);
        const newIngs = ingredients.map(i=>{
          const p = prevIngs.find(x=>x.t===i.t);
          return {t:i.t, done: p ? p.done : false};
        });
        return { ...r, name, tags, serves, time, ingredients:newIngs, steps, photo, updated:now };
      });
    }else{
      // yeni kayƒ±t
      const uid = Math.random().toString(36).slice(2,9);
      db.recipes.unshift({ id:uid, name, tags, serves, time, ingredients, steps, photo, created:now, updated:now });
    }
    localStorage.setItem(storeKey, JSON.stringify(db));
    const m=document.getElementById('modal'); m.classList.remove('open'); m.setAttribute('aria-hidden','true');
    location.reload();
  };

  // Ba≈ülat
  data = load();
  activeId = data.recipes[0]?.id || null;
  function renderAll(){ renderTagBar(); renderList(); }
  window.__renderList = renderList; // temizle butonu fallback kullanƒ±r
  renderAll(); renderDetail();

})();
</script>
</body>
</html>
